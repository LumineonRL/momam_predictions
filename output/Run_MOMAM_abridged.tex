% Options for packages loaded elsewhere
\PassOptionsToPackage{unicode}{hyperref}
\PassOptionsToPackage{hyphens}{url}
%
\documentclass[
]{article}
\usepackage{amsmath,amssymb}
\usepackage{iftex}
\ifPDFTeX
  \usepackage[T1]{fontenc}
  \usepackage[utf8]{inputenc}
  \usepackage{textcomp} % provide euro and other symbols
\else % if luatex or xetex
  \usepackage{unicode-math} % this also loads fontspec
  \defaultfontfeatures{Scale=MatchLowercase}
  \defaultfontfeatures[\rmfamily]{Ligatures=TeX,Scale=1}
\fi
\usepackage{lmodern}
\ifPDFTeX\else
  % xetex/luatex font selection
\fi
% Use upquote if available, for straight quotes in verbatim environments
\IfFileExists{upquote.sty}{\usepackage{upquote}}{}
\IfFileExists{microtype.sty}{% use microtype if available
  \usepackage[]{microtype}
  \UseMicrotypeSet[protrusion]{basicmath} % disable protrusion for tt fonts
}{}
\makeatletter
\@ifundefined{KOMAClassName}{% if non-KOMA class
  \IfFileExists{parskip.sty}{%
    \usepackage{parskip}
  }{% else
    \setlength{\parindent}{0pt}
    \setlength{\parskip}{6pt plus 2pt minus 1pt}}
}{% if KOMA class
  \KOMAoptions{parskip=half}}
\makeatother
\usepackage{xcolor}
\usepackage[margin=1in]{geometry}
\usepackage{color}
\usepackage{fancyvrb}
\newcommand{\VerbBar}{|}
\newcommand{\VERB}{\Verb[commandchars=\\\{\}]}
\DefineVerbatimEnvironment{Highlighting}{Verbatim}{commandchars=\\\{\}}
% Add ',fontsize=\small' for more characters per line
\usepackage{framed}
\definecolor{shadecolor}{RGB}{248,248,248}
\newenvironment{Shaded}{\begin{snugshade}}{\end{snugshade}}
\newcommand{\AlertTok}[1]{\textcolor[rgb]{0.94,0.16,0.16}{#1}}
\newcommand{\AnnotationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\AttributeTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{#1}}
\newcommand{\BaseNTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\BuiltInTok}[1]{#1}
\newcommand{\CharTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\CommentTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textit{#1}}}
\newcommand{\CommentVarTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\ConstantTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{#1}}
\newcommand{\ControlFlowTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\DataTypeTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{#1}}
\newcommand{\DecValTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\DocumentationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\ErrorTok}[1]{\textcolor[rgb]{0.64,0.00,0.00}{\textbf{#1}}}
\newcommand{\ExtensionTok}[1]{#1}
\newcommand{\FloatTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\FunctionTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\ImportTok}[1]{#1}
\newcommand{\InformationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\KeywordTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\NormalTok}[1]{#1}
\newcommand{\OperatorTok}[1]{\textcolor[rgb]{0.81,0.36,0.00}{\textbf{#1}}}
\newcommand{\OtherTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{#1}}
\newcommand{\PreprocessorTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textit{#1}}}
\newcommand{\RegionMarkerTok}[1]{#1}
\newcommand{\SpecialCharTok}[1]{\textcolor[rgb]{0.81,0.36,0.00}{\textbf{#1}}}
\newcommand{\SpecialStringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\StringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\VariableTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\VerbatimStringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\WarningTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\usepackage{graphicx}
\makeatletter
\def\maxwidth{\ifdim\Gin@nat@width>\linewidth\linewidth\else\Gin@nat@width\fi}
\def\maxheight{\ifdim\Gin@nat@height>\textheight\textheight\else\Gin@nat@height\fi}
\makeatother
% Scale images if necessary, so that they will not overflow the page
% margins by default, and it is still possible to overwrite the defaults
% using explicit options in \includegraphics[width, height, ...]{}
\setkeys{Gin}{width=\maxwidth,height=\maxheight,keepaspectratio}
% Set default figure placement to htbp
\makeatletter
\def\fps@figure{htbp}
\makeatother
\setlength{\emergencystretch}{3em} % prevent overfull lines
\providecommand{\tightlist}{%
  \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}
\setcounter{secnumdepth}{-\maxdimen} % remove section numbering
\ifLuaTeX
  \usepackage{selnolig}  % disable illegal ligatures
\fi
\IfFileExists{bookmark.sty}{\usepackage{bookmark}}{\usepackage{hyperref}}
\IfFileExists{xurl.sty}{\usepackage{xurl}}{} % add URL line breaks if available
\urlstyle{same}
\hypersetup{
  pdftitle={Run MOMAM - short ver.},
  pdfauthor={Michael Wiley},
  hidelinks,
  pdfcreator={LaTeX via pandoc}}

\title{Run MOMAM - short ver.}
\author{Michael Wiley}
\date{2023-12-03}

\begin{document}
\maketitle

\hypertarget{the-short-version-removes-the-data-extraction-and-database-building-steps-10-mins}{%
\subsection{The short version removes the data extraction and database
building steps (\textasciitilde10
mins)}\label{the-short-version-removes-the-data-extraction-and-database-building-steps-10-mins}}

\hypertarget{as-well-as-greatly-reducing-the-number-of-models-trained-1-hour-saved}{%
\subsection{as well as greatly reducing the number of models trained
(\textasciitilde1 hour
saved)}\label{as-well-as-greatly-reducing-the-number-of-models-trained-1-hour-saved}}

\hypertarget{step-0-setup}{%
\subsection{Step 0: Setup}\label{step-0-setup}}

Load all helper functions located in \texttt{lib}.

\begin{verbatim}
## [[1]]
## [[1]]$value
## function () 
## {
##     POST("https://id.twitch.tv/oauth2/token", query = list(client_id = get_client_id(), 
##         client_secret = get_client_secret(), grant_type = "client_credentials")) %>% 
##         use_series("content") %>% rawToChar() %>% fromJSON() %>% 
##         use_series("access_token") %>% return()
## }
## 
## [[1]]$visible
## [1] FALSE
## 
## 
## [[2]]
## [[2]]$value
## function (db) 
## {
##     games_all <- dbGetQuery(db, "SELECT DISTINCT game_id FROM game_data")
##     games_count <- nrow(games_all)
##     QUERY_LIMIT <- 500L
##     split_num <- 1L
##     if (games_count > QUERY_LIMIT) {
##         max_splits <- ceiling(games_count/QUERY_LIMIT)
##         while (split_num < max_splits) {
##             games_current <- rep(NA, QUERY_LIMIT)
##             games_current <- games_all$game_id[seq((split_num - 
##                 1) * QUERY_LIMIT + 1, split_num * QUERY_LIMIT)]
##             get_query(games_current) %>% post_query() %>% process_query() %>% 
##                 save_results(db, .)
##             split_num <- split_num + 1
##         }
##     }
##     games_current <- ifelse(games_count%%QUERY_LIMIT == 0, rep(NA, 
##         QUERY_LIMIT), rep(NA, games_count%%QUERY_LIMIT))
##     games_current <- games_all$game_id[seq((split_num - 1) * 
##         QUERY_LIMIT + 1, games_count)]
##     get_query(games_current) %>% post_query() %>% process_query() %>% 
##         save_results(db, .)
## }
## 
## [[2]]$visible
## [1] FALSE
## 
## 
## [[3]]
## [[3]]$value
## function (db) 
## {
##     past_results <- read_csv(str_c(here("data/momam7"), "/momam7_base_data.csv"))
##     games_list <- dbGetQuery(db, "SELECT DISTINCT game\n           FROM game_data;")
##     to_add_names <- past_results$game[which(!past_results$game %in% 
##         unlist(games_list))]
##     to_add_urls <- c("https://www.igdb.com/games/super-mario-land-2-6-golden-coins", 
##         "https://www.igdb.com/games/mega-man-3", "https://www.igdb.com/games/mega-man-7", 
##         "https://www.igdb.com/games/pokemon-card-gb2-great-rocket-dan-sanjou", 
##         "https://www.igdb.com/games/pokemon-puzzle-league", "https://www.igdb.com/games/wave-race-64", 
##         "https://www.igdb.com/games/f-zero-x", "https://www.igdb.com/games/contra-iii-the-alien-wars", 
##         "https://www.igdb.com/games/the-simpsons-hit-run", "https://www.igdb.com/games/kirby-and-the-forgotten-land", 
##         "https://www.igdb.com/games/ninja-gaiden-ii-the-dark-sword-of-chaos", 
##         "https://www.igdb.com/games/sonic-and-the-secret-rings", 
##         "https://www.igdb.com/games/sonic-forces", "https://www.igdb.com/games/monopoly-for-nintendo-switch", 
##         "https://www.igdb.com/games/spongebob-squarepants-the-cosmic-shake", 
##         "https://www.igdb.com/games/tony-hawks-pro-skater-3--1", 
##         "https://www.igdb.com/games/bubsy-in-claws-encounters-of-the-furred-kind")
##     to_add_ids <- sapply(to_add_urls, search_game_id)
##     to_add_names <- "Bubsy in Claws Encounters of the Furred Kind"
##     to_add_urls <- "https://www.igdb.com/games/bubsy-in-claws-encounters-of-the-furred-kind"
##     to_add_ids <- sapply(to_add_urls, search_game_id)
##     to_add_names <- "The Lord of the Rings: The Two Towers"
##     to_add_urls <- "https://www.igdb.com/games/the-lord-of-the-rings-the-two-towers"
##     to_add_ids <- sapply(to_add_urls, search_game_id)
##     to_add_names <- "Monopoly Plus"
##     to_add_urls <- "https://www.igdb.com/games/monopoly-plus"
##     to_add_ids <- sapply(to_add_urls, search_game_id)
##     insert <- dbSendStatement(db, "INSERT INTO game_data (game_id, game, url) VALUES (?, ?, ?) ON CONFLICT DO NOTHING")
##     dbBind(insert, list(to_add_ids, to_add_names, to_add_urls))
##     dbClearResult(insert)
## }
## 
## [[3]]$visible
## [1] FALSE
## 
## 
## [[4]]
## NULL
## 
## [[5]]
## [[5]]$value
## function (dbname, csv) 
## {
##     message(paste("\nNow reading:", csv))
##     v_streamer <- tolower(str_extract(csv, "(pie|Spike)"))
##     v_year <- str_extract(csv, "20[:number:]+") %>% as.numeric()
##     yearly_data <- read_csv(csv) %>% select(2, 3) %>% `colnames<-`(c("game", 
##         "minutes")) %>% mutate(streamer = v_streamer, year = v_year, 
##         game = str_extract(game, "[^|]+"), game = str_replace(game, 
##             "Ã©", "e"), game = sapply(game, pokemon_checker), 
##         url = str_to_lower(game), url = str_replace_all(url, 
##             "&", "and"), url = str_replace_all(url, "\\+", "plus"), 
##         url = str_remove_all(url, "[^([:alnum:]-?|[:space:]|'|$)]"), 
##         url = str_replace_all(url, "([:space:]+|')", "-"), url = str_replace(url, 
##             "chip-s", "chips"), url = str_replace(url, "freddy-s", 
##             "freddys"), url = str_replace(url, "igi-s-man", "igis-man"), 
##         url = str_replace(url, "known-s-bat", "knowns-bat"), 
##         url = str_replace(url, "let-s-go-pika", "lets-go-pika"), 
##         url = str_replace(url, "pooh-s-home", "poohs-home"), 
##         url = str_replace(url, "ter-s-aren", "ters-aren"), url = str_replace(url, 
##             "shi-s-wool", "shis-wool"), url = str_replace(url, 
##             "super-mario-3d-world-plus-bowser-s-fury", "super-mario-3d-world-plus-bowsers-fury"), 
##         url = str_replace(url, "shi-s-saf", "shis-saf"), url = str_replace(url, 
##             "mafiagg", "mafia-dot-gg"), url = str_replace(url, 
##             "o-hare", "ohare"), url = str_replace(url, "sid-meier-s-civilization-vi", 
##             "sid-meiers-civilization-vi"), url = str_replace(url, 
##             "4-it-s-abo", "4-its-abo"), url = str_replace(url, 
##             "evil-director-s-cut", "evil-directors-cut"), url = str_replace(url, 
##             "link-s-awakening", "links-awakening"), url = str_replace(url, 
##             "links-awakening-dx", "link-s-awakening-dx"), url = str_replace(url, 
##             "duelists-of-the-roses", "duelists-of-the-roses-fa82a70b-8784-4e43-babc-9ba06b3ba75d"), 
##         url = str_replace(url, "--", "-"), url = str_replace(url, 
##             "ing-harmony", "ing-harmony--1"), url = str_replace(url, 
##             "fate-of-atlantis", "fate-of-atlantis--1"), url = str_replace(url, 
##             "mike-tyson-s-punch-out", "punch-out--2"), url = str_replace(url, 
##             "hd-15", "hd-1-dot-5"), url = str_replace(url, "speedy-gonzales-in-los-gatos-banditos", 
##             "speedy-gonzales-los-gatos-bandidos"), url = str_replace(url, 
##             "mega-man-zerozx-legacy-collection", "mega-man-zero-slash-zx-legacy-collection"), 
##         url = str_replace(url, "dai-gyakuten-saiban-naruhodou-ryuunosuke-no-bouken", 
##             "dai-gyakuten-saiban-naruhodou-ryuunosuke-no-bouken-1-and-2-best-price"), 
##         url = str_replace(url, "mario-s-time-machine", "marios-time-machine"), 
##         url = str_replace(url, "sesame-street-elmo-s-number-journey", 
##             "sesame-street-elmos-number-journey"), url = str_replace(url, 
##             "sesame-street-elmo-s-letter-adventure", "sesame-street-elmos-letter-adventure--1"), 
##         url = str_replace(url, "25-remix", "2-dot-5-remix"), 
##         url = str_replace(url, "sonic-adventure-dx-director-s-cut", 
##             "sonic-adventure-dx-directors-cut"), url = str_replace(url, 
##             "shantae-and-the-pirate-s-curse", "shantae-and-the-pirates-curse"), 
##         url = str_replace(url, "^(disney-s-)?goof-troop$", "disneys-goof-troop"), 
##         url = str_replace(url, "marvel-s-spider-man", "marvels-spider-man"), 
##         url = str_replace(url, "spyro-2-ripto-s-rage--reignited", 
##             "spyro-2-riptos-rage-reignited"), url = str_replace(url, 
##             "clan-o-conall-and-the-crown-of-the-stag", "clan-oconall-and-the-crown-of-the-stag"), 
##         url = str_replace(url, "ratchet-and-clank-up-your-arsenal", 
##             "ratchet-clank-up-your-arsenal"), url = str_replace(url, 
##             "the-legend-of-zelda-ocarina-of-time--master-quest", 
##             "the-legend-of-zelda-ocarina-of-time-master-quest"), 
##         url = str_replace(url, "mario-and-luigi", "mario-luigi"), 
##         url = str_replace(url, "mario-luigi-superstar-saga-plus", 
##             "mario-and-luigi-superstar-saga-plus"), url = str_replace(url, 
##             "mario-luigi-paper-jam", "mario-and-luigi-paper-jam"), 
##         url = str_replace(url, "are-you-afraid-of-the-dark\\?-the-tale-of-orpheo-s-curse", 
##             "are-you-afraid-of-the-dark-the-tale-of-orpheo-s-curse"), 
##         url = str_replace(url, "phoenix-wright-ace-attorney--dual-destinies", 
##             "phoenix-wright-ace-attorney-dual-destinies"), url = str_replace(url, 
##             "kingdom-hearts-hd-28-final-chapter-prologue", "kingdom-hearts-hd-2-dot-8-final-chapter-prologue"), 
##         url = str_replace(url, "phoenix-wright-ace-attorney--spirit-of-justice", 
##             "phoenix-wright-ace-attorney-spirit-of-justice"), 
##         url = str_replace(url, "^[:graph:]{1}kami$", "okami"), 
##         url = str_replace(url, "star-wars-jedi-knight--jedi-academy", 
##             "star-wars-jedi-knight-jedi-academy"), url = str_replace(url, 
##             "man-and-bass", "man-bass"), url = str_c("https://www.igdb.com/games/", 
##             url), game_id = sapply(url, search_game_id)) %>% 
##         dplyr::filter(game_id >= 0) %>% select(streamer, year, 
##         game_id, game, minutes, url)
##     insert <- dbSendStatement(db, "INSERT INTO game_data (game_id, game, url) VALUES (?, ?, ?) ON CONFLICT DO NOTHING")
##     dbBind(insert, list(as.vector(yearly_data$game_id), as.vector(yearly_data$game), 
##         as.vector(yearly_data$url)))
##     dbClearResult(insert)
##     insert <- dbSendStatement(db, "INSERT INTO yearly_playtime (streamer, year, game_id, minutes) VALUES (?, ?, ?, ?) ON CONFLICT DO NOTHING")
##     dbBind(insert, list(as.vector(yearly_data$streamer), as.vector(yearly_data$year), 
##         as.vector(yearly_data$game_id), as.vector(yearly_data$minutes)))
##     dbClearResult(insert)
## }
## 
## [[5]]$visible
## [1] FALSE
\end{verbatim}

Various global environment variable setup:

Establish database connection Load all csv files Creates tables name
Loads API information

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\#db \textless{}{-} dbConnect(SQLite(), str\_c(here("output"), "/", "MOMAM.sqlite"))}
\NormalTok{db }\OtherTok{\textless{}{-}} \FunctionTok{connect\_db}\NormalTok{(}\FunctionTok{here}\NormalTok{(}\StringTok{"output"}\NormalTok{), }\StringTok{"MOMAM.sqlite"}\NormalTok{)}
\NormalTok{csvs }\OtherTok{\textless{}{-}} \FunctionTok{load\_all\_csvs\_from\_folder}\NormalTok{(}\FunctionTok{here}\NormalTok{(}\StringTok{"data/channel\_data/"}\NormalTok{))}

\NormalTok{tablenames }\OtherTok{\textless{}{-}} \FunctionTok{str\_c}\NormalTok{(}\FunctionTok{tolower}\NormalTok{(}\FunctionTok{str\_extract}\NormalTok{(csvs, }\StringTok{"(pie|Spike)"}\NormalTok{)),}
                    \FunctionTok{str\_extract}\NormalTok{(csvs, }\StringTok{"20[:number:]+"}\NormalTok{))}


\CommentTok{\# End points with necessary information from the API.}
\CommentTok{\# TO DO: Organize this into a single data structure.}
\NormalTok{api\_url }\OtherTok{\textless{}{-}} \StringTok{"https://api.igdb.com/v4"}
\NormalTok{end\_games }\OtherTok{\textless{}{-}} \StringTok{"/games"}
\NormalTok{end\_categories }\OtherTok{\textless{}{-}} \StringTok{"/categories"}
\NormalTok{end\_genres }\OtherTok{\textless{}{-}} \StringTok{"/genres"}
\NormalTok{end\_age }\OtherTok{\textless{}{-}} \StringTok{"/age\_ratings"}
\NormalTok{end\_company }\OtherTok{\textless{}{-}} \StringTok{"/involved\_companies"}
\NormalTok{end\_engines }\OtherTok{\textless{}{-}} \StringTok{"/game\_engines"}
\NormalTok{end\_platforms }\OtherTok{\textless{}{-}} \StringTok{"/platforms"}
\NormalTok{end\_franchises }\OtherTok{\textless{}{-}} \StringTok{"/franchises"}
\NormalTok{end\_themes }\OtherTok{\textless{}{-}} \StringTok{"/themes"}
\NormalTok{end\_keywords }\OtherTok{\textless{}{-}} \StringTok{"/keywords"}
\NormalTok{end\_perspectives }\OtherTok{\textless{}{-}} \StringTok{"/player\_perspectives"}

\NormalTok{client\_id }\OtherTok{\textless{}{-}} \FunctionTok{get\_client\_id}\NormalTok{()}
\NormalTok{access\_token }\OtherTok{\textless{}{-}} \FunctionTok{get\_access\_token}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\hypertarget{step-2-prepare-data-for-analysis}{%
\subsection{Step 2: Prepare Data for
Analysis}\label{step-2-prepare-data-for-analysis}}

The above step steps collected the necessary data and placed it into
normalized SQL tables

Now it's time to move that data into a analysis-ready format.

This cell here will connect to the database containing our game
metadata, as well the csv file holding the results of all previous
MOMAMs.

game\_list is our master list of games that the streamers have played
cumulative\_playtime is our list of how long each streamer spent playing
each game in total imputed\_yearly\_metadata lists pertinent metadata
for each game, such as genre and release data.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\#db \textless{}{-} connect\_db(here("output"), "MOMAM.sqlite")}
\NormalTok{past\_results }\OtherTok{\textless{}{-}} \FunctionTok{read\_csv}\NormalTok{(}\FunctionTok{str\_c}\NormalTok{(}\FunctionTok{here}\NormalTok{(}\StringTok{"data/momam7"}\NormalTok{), }\StringTok{"/momam7\_base\_data.csv"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Rows: 273 Columns: 5
## -- Column specification --------------------------------------------------------
## Delimiter: ","
## chr (3): game, category, winner
## dbl (2): MOMAM, grouping
## 
## i Use `spec()` to retrieve the full column specification for this data.
## i Specify the column types or set `show_col_types = FALSE` to quiet this message.
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{game\_list }\OtherTok{\textless{}{-}} \FunctionTok{dbGetQuery}\NormalTok{(db, }\StringTok{\textquotesingle{}SELECT game\_id, game FROM game\_data;\textquotesingle{}}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{as\_tibble}\NormalTok{()}

\NormalTok{cumulative\_playtime }\OtherTok{\textless{}{-}} \FunctionTok{dbGetQuery}\NormalTok{(db, }\StringTok{\textquotesingle{}SELECT * FROM cumulative\_playtime;\textquotesingle{}}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{as\_tibble}\NormalTok{()}

\NormalTok{imputed\_yearly\_metadata }\OtherTok{\textless{}{-}} \FunctionTok{dbGetQuery}\NormalTok{(db, }\StringTok{\textquotesingle{}SELECT * FROM imputed\_yearly\_metadata\textquotesingle{}}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{as\_tibble}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

The following cells will all focus around taking our db normalized data
and preparing it for analysis. The first thing to do is create dummy
variables columns for our categorical variables, but not our numeric
ones.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{past\_results\_with\_id }\OtherTok{\textless{}{-}}\NormalTok{ past\_results }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{left\_join}\NormalTok{(game\_list, }\AttributeTok{by =} \FunctionTok{join\_by}\NormalTok{(game)) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{left\_join}\NormalTok{(imputed\_yearly\_metadata, }\AttributeTok{by =} \FunctionTok{join\_by}\NormalTok{(game\_id }\SpecialCharTok{==}\NormalTok{ id), }\AttributeTok{relationship =} \StringTok{"many{-}to{-}many"}\NormalTok{)}

\NormalTok{past\_results\_categorical }\OtherTok{\textless{}{-}}\NormalTok{ past\_results\_with\_id }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(}\SpecialCharTok{!}\NormalTok{(name }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(}\StringTok{"first\_release\_date"}\NormalTok{, }\StringTok{"total\_rating"}\NormalTok{))) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{distinct}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{pivot\_wider}\NormalTok{(}\AttributeTok{names\_from =} \FunctionTok{c}\NormalTok{(name, value), }\AttributeTok{values\_from =}\NormalTok{ value,}
              \AttributeTok{names\_glue =} \StringTok{"\{name\}\_\{value\}"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{mutate}\NormalTok{(}\FunctionTok{across}\NormalTok{(}\SpecialCharTok{{-}}\FunctionTok{c}\NormalTok{(MOMAM, grouping, game, category, winner, game\_id),}
                \SpecialCharTok{\textasciitilde{}} \FunctionTok{ifelse}\NormalTok{(}\FunctionTok{is.na}\NormalTok{(.), }\DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{)))}

\NormalTok{past\_results\_numeric }\OtherTok{\textless{}{-}}\NormalTok{ past\_results\_with\_id }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{((name }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(}\StringTok{"first\_release\_date"}\NormalTok{, }\StringTok{"total\_rating"}\NormalTok{))) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{distinct}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{pivot\_wider}\NormalTok{(}\AttributeTok{names\_from =}\NormalTok{ name, }\AttributeTok{values\_from =}\NormalTok{ value, }\AttributeTok{values\_fn =}\NormalTok{ mean)}

\CommentTok{\# For reordering columns with the pivoted columns in the back.}
\NormalTok{desired\_order }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"winner"}\NormalTok{, }\StringTok{"MOMAM"}\NormalTok{, }\StringTok{"grouping"}\NormalTok{, }\StringTok{"game"}\NormalTok{, }\StringTok{"category"}\NormalTok{, }\StringTok{"game\_id"}\NormalTok{)}

\CommentTok{\# Combines the categorical and numeric dfs.}
\NormalTok{past\_results\_pivoted\_metadata }\OtherTok{\textless{}{-}}\NormalTok{ past\_results\_categorical }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{left\_join}\NormalTok{(past\_results\_numeric, }\AttributeTok{by =} \FunctionTok{join\_by}\NormalTok{(MOMAM, grouping, game, category, game\_id, winner)) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(}\FunctionTok{sort}\NormalTok{(}\FunctionTok{names}\NormalTok{(.))) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(}\FunctionTok{all\_of}\NormalTok{(desired\_order), }\FunctionTok{everything}\NormalTok{()) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(}\SpecialCharTok{{-}}\NormalTok{category) }\CommentTok{\# category is handled by the cumulative time function below.}
\end{Highlighting}
\end{Shaded}

Next is to deal with multi-game challenges. Sometimes one day will
consist of a race of 2 or more games and we need to treat these days one
prediction. To achieve this, each game that's played on the same day as
the data in all of their columns averaged out. The comments in the code
should have more detail.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Counts how many games are in each group.}
\CommentTok{\# A group is a set of games that either are being played or can be played on the same day.}
\CommentTok{\# For example, if there\textquotesingle{}s a bid war between Ocarina of Time and Majora\textquotesingle{}s Mask,}
\CommentTok{\# they would share the same grouping for that entry.}
\NormalTok{counts }\OtherTok{\textless{}{-}}\NormalTok{ past\_results }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{group\_by}\NormalTok{(grouping) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{count}\NormalTok{(grouping)}

\CommentTok{\# Splits games with multiple categories and assigns weights to each entry depending}
\CommentTok{\# on their grouping. All of the joins should go here.}
\NormalTok{past\_results\_pivoted }\OtherTok{\textless{}{-}}\NormalTok{ past\_results }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{left\_join}\NormalTok{(counts, }\AttributeTok{by =} \FunctionTok{join\_by}\NormalTok{(grouping)) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{mutate}\NormalTok{(}\AttributeTok{weight =} \DecValTok{1}\SpecialCharTok{/}\NormalTok{n) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(}\SpecialCharTok{{-}}\NormalTok{n) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{left\_join}\NormalTok{(game\_list, }\AttributeTok{by =} \FunctionTok{join\_by}\NormalTok{(game)) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{left\_join}\NormalTok{(cumulative\_playtime, }\AttributeTok{by =} \FunctionTok{join\_by}\NormalTok{(game\_id), }\AttributeTok{multiple =} \StringTok{"all"}\NormalTok{, }\AttributeTok{relationship =} \StringTok{"many{-}to{-}many"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{dummy\_cols}\NormalTok{(}\AttributeTok{select\_columns =} \FunctionTok{c}\NormalTok{(}\StringTok{"category"}\NormalTok{),}
             \AttributeTok{remove\_selected\_columns =}\NormalTok{ T,}
             \AttributeTok{split =} \StringTok{","}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{pivot\_wider}\NormalTok{(}\AttributeTok{names\_from =}\NormalTok{ streamer, }\AttributeTok{values\_from =}\NormalTok{ minutes, }\AttributeTok{values\_fill =} \DecValTok{0}\NormalTok{,}
              \AttributeTok{names\_glue =} \StringTok{"cum\_playtime\_\{streamer\}"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{left\_join}\NormalTok{(past\_results\_pivoted\_metadata, }\AttributeTok{by =} \FunctionTok{join\_by}\NormalTok{(MOMAM, grouping, game, winner, game\_id))}


\CommentTok{\# Sets the data up to be weighted. Will lose game id with this, so need to have all the data}
\CommentTok{\# ready to go by this point.}
\NormalTok{past\_results\_weighted }\OtherTok{\textless{}{-}}\NormalTok{ past\_results\_pivoted }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{pivot\_longer}\NormalTok{(}\AttributeTok{cols =} \FunctionTok{c}\NormalTok{(}\FunctionTok{starts\_with}\NormalTok{(}\StringTok{"category"}\NormalTok{), }\FunctionTok{starts\_with}\NormalTok{(}\StringTok{"cum"}\NormalTok{),}
                        \FunctionTok{starts\_with}\NormalTok{(}\StringTok{"first"}\NormalTok{), }\FunctionTok{starts\_with}\NormalTok{(}\StringTok{"franchise"}\NormalTok{),}
                        \FunctionTok{starts\_with}\NormalTok{(}\StringTok{"genre"}\NormalTok{), }\FunctionTok{starts\_with}\NormalTok{(}\StringTok{"involved"}\NormalTok{),}
                        \FunctionTok{starts\_with}\NormalTok{(}\StringTok{"platform"}\NormalTok{), }\FunctionTok{starts\_with}\NormalTok{(}\StringTok{"player"}\NormalTok{),}
                        \FunctionTok{starts\_with}\NormalTok{(}\StringTok{"theme"}\NormalTok{), }\FunctionTok{starts\_with}\NormalTok{(}\StringTok{"total"}\NormalTok{)), }\CommentTok{\# Brings all of the columns together}
               \AttributeTok{names\_to =} \StringTok{"placeholder"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}                        \CommentTok{\# that need to be weighted.}
  \FunctionTok{mutate}\NormalTok{(}\AttributeTok{weighted\_val =}\NormalTok{ value }\SpecialCharTok{*}\NormalTok{ weight) }\SpecialCharTok{\%\textgreater{}\%} \CommentTok{\# Applies the weight}
  \FunctionTok{group\_by}\NormalTok{(MOMAM, grouping, winner, placeholder) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{summarise}\NormalTok{(}\AttributeTok{weighted\_group =} \FunctionTok{sum}\NormalTok{(weighted\_val)) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{pivot\_wider}\NormalTok{(}\AttributeTok{names\_from =}\NormalTok{ placeholder, }\AttributeTok{values\_from =}\NormalTok{ weighted\_group, }\AttributeTok{values\_fill =} \DecValTok{0}\NormalTok{) }\CommentTok{\# Puts the data back in their dummy column}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## `summarise()` has grouped output by 'MOMAM', 'grouping', 'winner'. You can
## override using the `.groups` argument.
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{head}\NormalTok{(past\_results\_weighted)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## # A tibble: 6 x 703
## # Groups:   MOMAM, grouping, winner [6]
##   MOMAM grouping winner `category_100%` `category_Any%` `category_CPU Battle`
##   <dbl>    <dbl> <chr>            <dbl>           <dbl>                 <dbl>
## 1     1        1 spike                0               1                     0
## 2     1        2 pie                  0               1                     0
## 3     1        3 pie                  0               1                     0
## 4     1        4 pie                  0               1                     0
## 5     1        5 spike                0               1                     0
## 6     1        6 spike                0               1                     0
## # i 697 more variables: category_Challenge <dbl>, category_Community <dbl>,
## #   category_Hard <dbl>, `category_Low%` <dbl>, category_Rando <dbl>,
## #   `category_Rom hack` <dbl>, cum_playtime_NA <dbl>, cum_playtime_pie <dbl>,
## #   cum_playtime_spike <dbl>, first_release_date <dbl>, franchises_1 <dbl>,
## #   franchises_100 <dbl>, franchises_1068 <dbl>, franchises_1071 <dbl>,
## #   franchises_11 <dbl>, franchises_1228 <dbl>, franchises_123 <dbl>,
## #   franchises_1351 <dbl>, franchises_145 <dbl>, franchises_147 <dbl>, ...
\end{verbatim}

Note that this is problematic here - there are significantly more
columns than rows at the moment.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{dim}\NormalTok{(past\_results\_weighted)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 230 703
\end{verbatim}

\hypertarget{step-3-analysis}{%
\subsection{Step 3: Analysis}\label{step-3-analysis}}

Now that the data has been created, it's time to analyze it.

First up, a preprocessing workflow is created. Since we have so many
columns - many of which have near-zero variance, we will filter those
out.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{past\_results\_weighted}\SpecialCharTok{$}\NormalTok{winner }\OtherTok{\textless{}{-}} \FunctionTok{as.factor}\NormalTok{(past\_results\_weighted}\SpecialCharTok{$}\NormalTok{winner)}

\FunctionTok{set.seed}\NormalTok{(}\DecValTok{323}\NormalTok{)}

\CommentTok{\# Ideally the size of the test set will be the size of the last MOMAM. }
\NormalTok{target\_split }\OtherTok{\textless{}{-}} \DecValTok{1} \SpecialCharTok{{-}}
  \FunctionTok{nrow}\NormalTok{(past\_results\_weighted[past\_results\_weighted}\SpecialCharTok{$}\NormalTok{MOMAM }\SpecialCharTok{==} \DecValTok{7}\NormalTok{, ]) }\SpecialCharTok{/}
  \FunctionTok{nrow}\NormalTok{(past\_results\_weighted)}

\NormalTok{initial\_split }\OtherTok{\textless{}{-}} \FunctionTok{initial\_split}\NormalTok{(past\_results\_weighted,}
              \AttributeTok{prop =}\NormalTok{ target\_split,}
              \AttributeTok{strata =}\NormalTok{ MOMAM)}

\NormalTok{momam\_train }\OtherTok{\textless{}{-}} \FunctionTok{training}\NormalTok{(initial\_split)}
\NormalTok{momam\_test }\OtherTok{\textless{}{-}} \FunctionTok{testing}\NormalTok{(initial\_split)}

\NormalTok{momam\_folds }\OtherTok{\textless{}{-}} \FunctionTok{vfold\_cv}\NormalTok{(momam\_train)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{base\_recipe }\OtherTok{\textless{}{-}} \FunctionTok{recipe}\NormalTok{(winner }\SpecialCharTok{\textasciitilde{}}\NormalTok{ ., }\AttributeTok{data =}\NormalTok{ momam\_train) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{step\_rm}\NormalTok{(grouping) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{step\_mutate}\NormalTok{(}\AttributeTok{cum\_playtime\_pie =} \FunctionTok{log}\NormalTok{(cum\_playtime\_pie }\SpecialCharTok{+} \DecValTok{1}\NormalTok{)) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{step\_mutate}\NormalTok{(}\AttributeTok{cum\_playtime\_spike =} \FunctionTok{log}\NormalTok{(cum\_playtime\_spike }\SpecialCharTok{+} \DecValTok{1}\NormalTok{)) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{step\_naomit}\NormalTok{(}\FunctionTok{c}\NormalTok{(cum\_playtime\_pie, cum\_playtime\_spike)) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{step\_nzv}\NormalTok{(}\FunctionTok{all\_predictors}\NormalTok{(), }\AttributeTok{freq\_cut =} \FloatTok{0.01}\NormalTok{, }\AttributeTok{unique\_cut =} \DecValTok{0}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{step\_zv}\NormalTok{(}\FunctionTok{all\_predictors}\NormalTok{()) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{step\_lincomb}\NormalTok{(}\FunctionTok{all\_numeric\_predictors}\NormalTok{()) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{step\_corr}\NormalTok{(}\FunctionTok{all\_predictors}\NormalTok{()) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{step\_normalize}\NormalTok{(}\FunctionTok{all\_predictors}\NormalTok{())}

\CommentTok{\# An opinionated way of reducing the dimensionality. This will create different}
\CommentTok{\# PCs for each group of variables.}
\CommentTok{\# However, different thresholds are used for each of categories because domain}
\CommentTok{\# knowledge tells me that some of these items are significantly more important}
\CommentTok{\# than others.}
\CommentTok{\# For example, enough PCs are taken from genre columns in order to explain}
\CommentTok{\# at least 90\% of the variance because genre is one of the most important factors}
\CommentTok{\# for who will end up winning.}
\NormalTok{grouped\_pca }\OtherTok{\textless{}{-}} \FunctionTok{recipe}\NormalTok{(winner }\SpecialCharTok{\textasciitilde{}}\NormalTok{ ., }\AttributeTok{data =}\NormalTok{ momam\_train) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{step\_rm}\NormalTok{(grouping) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{step\_mutate}\NormalTok{(}\AttributeTok{cum\_playtime\_pie =} \FunctionTok{log}\NormalTok{(cum\_playtime\_pie }\SpecialCharTok{+} \DecValTok{1}\NormalTok{)) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{step\_mutate}\NormalTok{(}\AttributeTok{cum\_playtime\_spike =} \FunctionTok{log}\NormalTok{(cum\_playtime\_spike }\SpecialCharTok{+} \DecValTok{1}\NormalTok{)) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{step\_naomit}\NormalTok{(}\FunctionTok{c}\NormalTok{(cum\_playtime\_pie, cum\_playtime\_spike)) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{step\_zv}\NormalTok{(}\FunctionTok{all\_predictors}\NormalTok{()) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{step\_normalize}\NormalTok{(}\FunctionTok{all\_predictors}\NormalTok{()) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{step\_pca}\NormalTok{(}\FunctionTok{starts\_with}\NormalTok{(}\StringTok{"category"}\NormalTok{), }\AttributeTok{threshold =} \FloatTok{0.5}\NormalTok{, }\AttributeTok{prefix =} \StringTok{"category\_"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{step\_pca}\NormalTok{(}\FunctionTok{starts\_with}\NormalTok{(}\StringTok{"cum"}\NormalTok{), }\AttributeTok{threshold =} \FloatTok{0.8}\NormalTok{, }\AttributeTok{prefix =} \StringTok{"cum"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{step\_pca}\NormalTok{(}\FunctionTok{starts\_with}\NormalTok{(}\StringTok{"franchises"}\NormalTok{), }\AttributeTok{threshold =} \FloatTok{0.2}\NormalTok{, }\AttributeTok{prefix =} \StringTok{"franchises"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{step\_pca}\NormalTok{(}\FunctionTok{starts\_with}\NormalTok{(}\StringTok{"genres"}\NormalTok{), }\AttributeTok{threshold =} \FloatTok{0.9}\NormalTok{, }\AttributeTok{prefix =} \StringTok{"genres"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{step\_pca}\NormalTok{(}\FunctionTok{starts\_with}\NormalTok{(}\StringTok{"platforms"}\NormalTok{), }\AttributeTok{threshold =} \FloatTok{0.80}\NormalTok{, }\AttributeTok{prefix =} \StringTok{"platforms"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{step\_pca}\NormalTok{(}\FunctionTok{starts\_with}\NormalTok{(}\StringTok{"player"}\NormalTok{), }\AttributeTok{threshold =} \FloatTok{0.8}\NormalTok{, }\AttributeTok{prefix =} \StringTok{"player"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{step\_pca}\NormalTok{(}\FunctionTok{starts\_with}\NormalTok{(}\StringTok{"themes"}\NormalTok{), }\AttributeTok{threshold =} \FloatTok{0.8}\NormalTok{, }\AttributeTok{prefix =} \StringTok{"themes"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{step\_pca}\NormalTok{(}\FunctionTok{starts\_with}\NormalTok{(}\StringTok{"involved"}\NormalTok{), }\AttributeTok{threshold =} \FloatTok{0.2}\NormalTok{, }\AttributeTok{prefix =} \StringTok{"involved"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{step\_corr}\NormalTok{(}\FunctionTok{all\_predictors}\NormalTok{(), }\AttributeTok{threshold =} \FloatTok{0.9}\NormalTok{)}

\CommentTok{\# Preforms an additional PCA on the grouped PCA since the dimensionality produced}
\CommentTok{\# by that approach is still rather high.}
\CommentTok{\# this processor ends up being one of the most effective after training.}
\NormalTok{hierarchical\_pca }\OtherTok{\textless{}{-}}\NormalTok{ grouped\_pca }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{step\_pca}\NormalTok{(}\SpecialCharTok{{-}}\FunctionTok{c}\NormalTok{(}\StringTok{"MOMAM"}\NormalTok{, }\StringTok{"first\_release\_date"}\NormalTok{, }\StringTok{"total\_rating"}\NormalTok{, }\StringTok{"winner"}\NormalTok{),}
           \AttributeTok{threshold =} \FloatTok{0.8}\NormalTok{, }\AttributeTok{prefix =} \StringTok{"hier\_"}\NormalTok{)}

\NormalTok{pca\_strict\_recipe }\OtherTok{\textless{}{-}}\NormalTok{ base\_recipe }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{step\_pca}\NormalTok{(}\FunctionTok{all\_predictors}\NormalTok{(), }\AttributeTok{threshold =} \FloatTok{0.8}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

Define models:

These are the models is trained on. Currently a few simple models are
here as a baseline, but ideally more will be used.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{model\_dt }\OtherTok{\textless{}{-}} \FunctionTok{decision\_tree}\NormalTok{(}\AttributeTok{tree\_depth =} \FunctionTok{tune}\NormalTok{(), }\AttributeTok{min\_n =} \FunctionTok{tune}\NormalTok{(), }\AttributeTok{cost\_complexity =} \FunctionTok{tune}\NormalTok{()) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{set\_engine}\NormalTok{(}\StringTok{"rpart"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{set\_mode}\NormalTok{(}\StringTok{"classification"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{translate}\NormalTok{()}

\NormalTok{model\_rf }\OtherTok{\textless{}{-}} \FunctionTok{rand\_forest}\NormalTok{(}\AttributeTok{mtry =} \FunctionTok{tune}\NormalTok{(), }\AttributeTok{trees =} \FunctionTok{tune}\NormalTok{(), }\AttributeTok{min\_n =} \FunctionTok{tune}\NormalTok{()) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{set\_engine}\NormalTok{(}\StringTok{"randomForest"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{set\_mode}\NormalTok{(}\StringTok{"classification"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{translate}\NormalTok{()}

\NormalTok{model\_xgb }\OtherTok{\textless{}{-}} \FunctionTok{boost\_tree}\NormalTok{(}\AttributeTok{tree\_depth =} \FunctionTok{tune}\NormalTok{(),}
                        \AttributeTok{trees =} \FunctionTok{tune}\NormalTok{(),}
                        \AttributeTok{learn\_rate =} \FunctionTok{tune}\NormalTok{(),}
                        \AttributeTok{mtry =} \FunctionTok{tune}\NormalTok{(),}
                        \AttributeTok{min\_n =} \FunctionTok{tune}\NormalTok{(),}
                        \AttributeTok{loss\_reduction =} \FunctionTok{tune}\NormalTok{(),}
                        \AttributeTok{sample\_size =} \FunctionTok{tune}\NormalTok{(),}
                        \AttributeTok{stop\_iter =} \FunctionTok{tune}\NormalTok{()) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{set\_engine}\NormalTok{(}\StringTok{"xgboost"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{set\_mode}\NormalTok{(}\StringTok{"classification"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{translate}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

List of models to train. Each model will be trained with each
preprocessing technique.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{momam\_workflowset }\OtherTok{\textless{}{-}} \FunctionTok{workflow\_set}\NormalTok{(}
  \AttributeTok{preproc =} \FunctionTok{list}\NormalTok{(}\AttributeTok{base =}\NormalTok{ base\_recipe,}
                 \AttributeTok{strict =}\NormalTok{ pca\_strict\_recipe,}
                 \AttributeTok{hierarchical\_pca =}\NormalTok{ hierarchical\_pca),}
  \AttributeTok{models =} \FunctionTok{list}\NormalTok{(}
    \AttributeTok{decision\_tree =}\NormalTok{ model\_dt,}
    \AttributeTok{rand\_forest =}\NormalTok{ model\_rf,}
    \AttributeTok{xgboost =}\NormalTok{ model\_xgb}
\NormalTok{  ),}
  \AttributeTok{cross =} \ConstantTok{TRUE}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

Trains and tunes each model with each pre-processor.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{race\_ctrl }\OtherTok{\textless{}{-}}
  \FunctionTok{control\_race}\NormalTok{(}
    \AttributeTok{save\_pred =} \ConstantTok{TRUE}\NormalTok{,}
    \AttributeTok{parallel\_over =} \StringTok{"everything"}\NormalTok{,}
    \AttributeTok{save\_workflow =} \ConstantTok{TRUE}
\NormalTok{  )}

\FunctionTok{library}\NormalTok{(doParallel)}
\NormalTok{doParallel}\SpecialCharTok{::}\FunctionTok{registerDoParallel}\NormalTok{(}\AttributeTok{cores =} \DecValTok{10}\NormalTok{)}

\NormalTok{grid\_results }\OtherTok{\textless{}{-}}
\NormalTok{  momam\_workflowset }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{workflow\_map}\NormalTok{(}
    \StringTok{"tune\_race\_anova"}\NormalTok{,}
    \AttributeTok{seed =} \DecValTok{0323}\NormalTok{,}
    \AttributeTok{resamples =}\NormalTok{ momam\_folds,}
    \AttributeTok{grid =} \DecValTok{15}\NormalTok{,}
    \AttributeTok{control =}\NormalTok{ race\_ctrl,}
    \AttributeTok{verbose =} \ConstantTok{TRUE}
\NormalTok{  )}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## i 1 of 9 tuning:     base_decision_tree
\end{verbatim}

\begin{verbatim}
## v 1 of 9 tuning:     base_decision_tree (56.6s)
\end{verbatim}

\begin{verbatim}
## i 2 of 9 tuning:     base_rand_forest
\end{verbatim}

\begin{verbatim}
## i Creating pre-processing data to finalize unknown parameter: mtry
\end{verbatim}

\begin{verbatim}
## v 2 of 9 tuning:     base_rand_forest (54.6s)
\end{verbatim}

\begin{verbatim}
## i 3 of 9 tuning:     base_xgboost
\end{verbatim}

\begin{verbatim}
## i Creating pre-processing data to finalize unknown parameter: mtry
\end{verbatim}

\begin{verbatim}
## v 3 of 9 tuning:     base_xgboost (30.6s)
\end{verbatim}

\begin{verbatim}
## i 4 of 9 tuning:     strict_decision_tree
\end{verbatim}

\begin{verbatim}
## v 4 of 9 tuning:     strict_decision_tree (26.5s)
\end{verbatim}

\begin{verbatim}
## i 5 of 9 tuning:     strict_rand_forest
\end{verbatim}

\begin{verbatim}
## i Creating pre-processing data to finalize unknown parameter: mtry
\end{verbatim}

\begin{verbatim}
## v 5 of 9 tuning:     strict_rand_forest (48.3s)
\end{verbatim}

\begin{verbatim}
## i 6 of 9 tuning:     strict_xgboost
\end{verbatim}

\begin{verbatim}
## i Creating pre-processing data to finalize unknown parameter: mtry
\end{verbatim}

\begin{verbatim}
## v 6 of 9 tuning:     strict_xgboost (36.2s)
\end{verbatim}

\begin{verbatim}
## i 7 of 9 tuning:     hierarchical_pca_decision_tree
\end{verbatim}

\begin{verbatim}
## v 7 of 9 tuning:     hierarchical_pca_decision_tree (32.9s)
\end{verbatim}

\begin{verbatim}
## i 8 of 9 tuning:     hierarchical_pca_rand_forest
\end{verbatim}

\begin{verbatim}
## i Creating pre-processing data to finalize unknown parameter: mtry
\end{verbatim}

\begin{verbatim}
## v 8 of 9 tuning:     hierarchical_pca_rand_forest (45.1s)
\end{verbatim}

\begin{verbatim}
## i 9 of 9 tuning:     hierarchical_pca_xgboost
\end{verbatim}

\begin{verbatim}
## i Creating pre-processing data to finalize unknown parameter: mtry
\end{verbatim}

\begin{verbatim}
## v 9 of 9 tuning:     hierarchical_pca_xgboost (44s)
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{doParallel}\SpecialCharTok{::}\FunctionTok{stopImplicitCluster}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

Displays how the models performed. Accuracy was chosen as the metric
since we care more about predicting the winner correctly by any means
necessary moreso than which predictions the model is getting right or
wrong.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{autoplot}\NormalTok{(}
\NormalTok{  grid\_results,}
  \AttributeTok{rank\_metric =} \StringTok{"accuracy"}\NormalTok{,  }\CommentTok{\# \textless{}{-} how to order models}
  \CommentTok{\#metric = "accuracy",       \# \textless{}{-} which metric to visualize}
  \AttributeTok{select\_best =} \ConstantTok{TRUE}     \CommentTok{\# \textless{}{-} one point per workflow}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\includegraphics{Run_MOMAM_abridged_files/figure-latex/evaluate-1.pdf}

Ranks each of the trained models.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{grid\_results }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{  workflowsets}\SpecialCharTok{::}\FunctionTok{rank\_results}\NormalTok{(}\AttributeTok{rank\_metric =} \StringTok{"accuracy"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{pivot\_wider}\NormalTok{(}\AttributeTok{names\_from =}\NormalTok{ .metric, }\AttributeTok{values\_from =}\NormalTok{ mean) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{group\_by}\NormalTok{(.config) }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{fill}\NormalTok{(accuracy, roc\_auc, }\AttributeTok{.direction =} \StringTok{"downup"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{distinct}\NormalTok{(rank, }\AttributeTok{.keep\_all =} \ConstantTok{TRUE}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{mutate}\NormalTok{(}\AttributeTok{preprocessor =} \FunctionTok{str\_extract}\NormalTok{(wflow\_id, }\StringTok{".*?(?=\_)"}\NormalTok{)) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{select}\NormalTok{(wflow\_id, model, preprocessor, accuracy, roc\_auc, rank) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{arrange}\NormalTok{(}\FunctionTok{desc}\NormalTok{(roc\_auc))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Adding missing grouping variables: `.config`
\end{verbatim}

\begin{verbatim}
## # A tibble: 71 x 7
## # Groups:   .config [15]
##    .config               wflow_id      model preprocessor accuracy roc_auc  rank
##    <chr>                 <chr>         <chr> <chr>           <dbl>   <dbl> <int>
##  1 Preprocessor1_Model10 hierarchical~ rand~ hierarchical    0.577   0.653    45
##  2 Preprocessor1_Model05 base_rand_fo~ rand~ base            0.599   0.651    15
##  3 Preprocessor1_Model05 hierarchical~ deci~ hierarchical    0.587   0.651    39
##  4 Preprocessor1_Model13 hierarchical~ rand~ hierarchical    0.556   0.651    53
##  5 Preprocessor1_Model07 base_rand_fo~ rand~ base            0.599   0.651    16
##  6 Preprocessor1_Model07 hierarchical~ rand~ hierarchical    0.588   0.651    36
##  7 Preprocessor1_Model03 base_rand_fo~ rand~ base            0.609   0.647     7
##  8 Preprocessor1_Model03 hierarchical~ deci~ hierarchical    0.609   0.647    11
##  9 Preprocessor1_Model06 hierarchical~ rand~ hierarchical    0.582   0.646    43
## 10 Preprocessor1_Model04 base_rand_fo~ rand~ base            0.615   0.643     5
## # i 61 more rows
\end{verbatim}

View the tuning parameters of the best model.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{best\_results }\OtherTok{\textless{}{-}} 
\NormalTok{  grid\_results }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{extract\_workflow\_set\_result}\NormalTok{(}\StringTok{"hierarchical\_pca\_rand\_forest"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{select\_best}\NormalTok{(}\AttributeTok{metric =} \StringTok{"accuracy"}\NormalTok{)}

\NormalTok{best\_results}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## # A tibble: 1 x 4
##    mtry trees min_n .config              
##   <int> <int> <int> <chr>                
## 1     4  1921    34 Preprocessor1_Model09
\end{verbatim}

Extract the best model and see how it performs on the test set.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{best\_test\_results }\OtherTok{\textless{}{-}} 
\NormalTok{  grid\_results }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{extract\_workflow}\NormalTok{(}\StringTok{"hierarchical\_pca\_rand\_forest"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{finalize\_workflow}\NormalTok{(best\_results) }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{last\_fit}\NormalTok{(}\AttributeTok{split =}\NormalTok{ initial\_split)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Warning: package 'randomForest' was built under R version 4.3.2
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{best\_test\_results}\SpecialCharTok{$}\NormalTok{.metrics}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [[1]]
## # A tibble: 2 x 4
##   .metric  .estimator .estimate .config             
##   <chr>    <chr>          <dbl> <chr>               
## 1 accuracy binary         0.537 Preprocessor1_Model1
## 2 roc_auc  binary         0.617 Preprocessor1_Model1
\end{verbatim}

View individual predictions of the best model on the test set.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{predictions }\OtherTok{\textless{}{-}}\NormalTok{ best\_test\_results }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{collect\_predictions}\NormalTok{() }

\NormalTok{predictions}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## # A tibble: 41 x 7
##    id               .pred_pie .pred_spike  .row .pred_class winner .config      
##    <chr>                <dbl>       <dbl> <int> <fct>       <fct>  <chr>        
##  1 train/test split    0.590       0.410      5 pie         spike  Preprocessor~
##  2 train/test split    0.796       0.204      6 pie         spike  Preprocessor~
##  3 train/test split    0.488       0.512     10 spike       pie    Preprocessor~
##  4 train/test split    0.0755      0.925     11 spike       spike  Preprocessor~
##  5 train/test split    0.412       0.588     17 spike       spike  Preprocessor~
##  6 train/test split    0.367       0.633     18 spike       spike  Preprocessor~
##  7 train/test split    0.370       0.630     20 spike       spike  Preprocessor~
##  8 train/test split    0.919       0.0812    37 pie         pie    Preprocessor~
##  9 train/test split    0.603       0.397     39 pie         spike  Preprocessor~
## 10 train/test split    0.501       0.499     56 pie         spike  Preprocessor~
## # i 31 more rows
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{predictions }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{mutate}\NormalTok{(}\AttributeTok{correct =} \FunctionTok{ifelse}\NormalTok{(.pred\_class }\SpecialCharTok{==}\NormalTok{ winner, }\DecValTok{1}\NormalTok{, }\DecValTok{0}\NormalTok{)) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{mutate}\NormalTok{(}\AttributeTok{weighted\_answer =} \FunctionTok{case\_when}\NormalTok{(winner }\SpecialCharTok{==} \StringTok{"pie"} \SpecialCharTok{\textasciitilde{}}\NormalTok{ .pred\_pie,}
\NormalTok{                                     T }\SpecialCharTok{\textasciitilde{}}\NormalTok{ .pred\_spike)) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{summarise}\NormalTok{(}\AttributeTok{test\_acc =} \FunctionTok{sum}\NormalTok{(correct)}\SpecialCharTok{/}\FunctionTok{nrow}\NormalTok{(.), }\AttributeTok{test\_roc =} \FunctionTok{sum}\NormalTok{(weighted\_answer)}\SpecialCharTok{/}\FunctionTok{nrow}\NormalTok{(.))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## # A tibble: 1 x 2
##   test_acc test_roc
##      <dbl>    <dbl>
## 1    0.537    0.523
\end{verbatim}

\end{document}
